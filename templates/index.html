<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Guild Wars 2 World vs World Command Center - Track WvW matches, guild activity, and alliance statistics">
    <meta name="theme-color" content="#d4af37">
    <title>GW2 WvW Command Center</title>

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="/static/icon.svg">
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icon-512.png">
    <link rel="apple-touch-icon" href="/static/icon-192.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">

    <!-- Styles -->
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>‚öîÔ∏è GW2 WvW Command Center</h1>
            <div id="account-badge" class="account-badge"></div>
        </header>

        <!-- Navigation -->
        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
            <button class="nav-tab" data-tab="account">Account</button>
            <button class="nav-tab" data-tab="characters">Characters</button>
            <button class="nav-tab" data-tab="trading">Trading Post</button>
            <button class="nav-tab" data-tab="query">Custom Query</button>
            <button class="nav-tab" data-tab="settings">Settings</button>
        </nav>

        <!-- Tab Contents -->
        <main class="content">
            <!-- Dashboard Tab -->
                        <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <h2>‚öîÔ∏è WvW Command Center</h2>
                
                <!-- Live WvW Stats Cards -->
                <div class="stats-cards">
                    <div class="stat-card" onclick="loadAccountQuick()">
                        <div class="stat-icon">üë§</div>
                        <div class="stat-content">
                            <div class="stat-label">Account</div>
                            <div class="stat-value" id="stat-account-name">Loading...</div>
                        </div>
                    </div>
                    
                    <div class="stat-card" id="stat-card-vp">
                        <div class="stat-icon">üèÜ</div>
                        <div class="stat-content">
                            <div class="stat-label">Victory Points</div>
                            <div class="stat-value" id="stat-victory-points">--</div>
                        </div>
                    </div>
                    
                    <div class="stat-card" id="stat-card-score">
                        <div class="stat-icon">‚öîÔ∏è</div>
                        <div class="stat-content">
                            <div class="stat-label">War Score</div>
                            <div class="stat-value" id="stat-war-score">--</div>
                        </div>
                    </div>
                    
                    <div class="stat-card" id="stat-card-kd">
                        <div class="stat-icon">üíÄ</div>
                        <div class="stat-content">
                            <div class="stat-label">K/D Ratio</div>
                            <div class="stat-value" id="stat-kd-ratio">--</div>
                        </div>
                    </div>
                </div>
                
                <!-- WvW Match Overview -->
                <div class="wvw-match-overview">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h3>üìä Current Matchup</h3>
                        <div id="tier-badge" class="tier-badge" style="display: none;"></div>
                    </div>
                    <div id="match-overview-content">
                        <p style="text-align: center; opacity: 0.6;">Click "Reload Match Data" to load matchup details</p>
                    </div>
                </div>

                <!-- Enhanced WvW Stats -->
                <div class="wvw-enhanced-stats" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;">
                    <!-- PPT and Skirmish Info -->
                    <div class="stat-panel">
                        <h3>‚è±Ô∏è Live Stats</h3>
                        <div id="ppt-display" class="ppt-container">
                            <div class="ppt-item">
                                <span class="ppt-label" id="ppt-red-label" style="color: #ff6b6b;">Red Team:</span>
                                <span class="ppt-value" id="ppt-red">--</span>
                            </div>
                            <div class="ppt-item">
                                <span class="ppt-label" id="ppt-green-label" style="color: #6bff6b;">Green Team:</span>
                                <span class="ppt-value" id="ppt-green">--</span>
                            </div>
                            <div class="ppt-item">
                                <span class="ppt-label" id="ppt-blue-label" style="color: #6b6bff;">Blue Team:</span>
                                <span class="ppt-value" id="ppt-blue">--</span>
                            </div>
                            <div class="skirmish-timer" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #444;">
                                <div style="font-size: 0.9em; opacity: 0.8;">Next Skirmish In:</div>
                                <div id="skirmish-countdown" style="font-size: 1.5em; font-weight: bold; color: #d4af37;">--:--</div>
                                <div id="skirmish-info" style="font-size: 0.85em; opacity: 0.7; margin-top: 5px;">Skirmish -- / --</div>
                            </div>
                        </div>
                    </div>

                    <!-- Territory Control -->
                    <div class="stat-panel">
                        <h3>üó∫Ô∏è Territory Control</h3>
                        <div id="territory-display" class="territory-container">
                            <div class="territory-item">
                                <div class="territory-header">
                                    <span class="territory-team" id="territory-red-team" style="color: #ff6b6b;">Red Team</span>
                                    <span class="territory-percent" id="territory-red-percent">--%</span>
                                </div>
                                <div class="territory-bar">
                                    <div class="territory-fill" id="territory-red-bar" style="width: 0%; background: #ff6b6b;"></div>
                                </div>
                                <div class="territory-details" id="territory-red-details">-- objectives</div>
                            </div>
                            <div class="territory-item">
                                <div class="territory-header">
                                    <span class="territory-team" id="territory-green-team" style="color: #6bff6b;">Green Team</span>
                                    <span class="territory-percent" id="territory-green-percent">--%</span>
                                </div>
                                <div class="territory-bar">
                                    <div class="territory-fill" id="territory-green-bar" style="width: 0%; background: #6bff6b;"></div>
                                </div>
                                <div class="territory-details" id="territory-green-details">-- objectives</div>
                            </div>
                            <div class="territory-item">
                                <div class="territory-header">
                                    <span class="territory-team" id="territory-blue-team" style="color: #6b6bff;">Blue Team</span>
                                    <span class="territory-percent" id="territory-blue-percent">--%</span>
                                </div>
                                <div class="territory-bar">
                                    <div class="territory-fill" id="territory-blue-bar" style="width: 0%; background: #6b6bff;"></div>
                                </div>
                                <div class="territory-details" id="territory-blue-details">-- objectives</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Action Panel -->
                <div class="quick-actions-panel">
                    <h3>üéØ Quick Actions</h3>
                    <div class="action-grid">
                        <button class="action-btn action-primary" onclick="reloadMatchData()">
                            <span class="action-icon">üîÑ</span>
                            <span class="action-text">
                                <strong>Reload Match Data</strong>
                                <small>Refresh your matchup stats and details</small>
                            </span>
                        </button>
                        
                        <button class="action-btn action-success" onclick="loadTrackedGuildsQuick()">
                            <span class="action-icon">üìä</span>
                            <span class="action-text">
                                <strong>Tracked Guilds</strong>
                                <small>View accumulated guild data</small>
                            </span>
                        </button>
                        
                        <button class="action-btn action-info" onclick="loadAccountQuick()">
                            <span class="action-icon">üë§</span>
                            <span class="action-text">
                                <strong>Account Info</strong>
                                <small>View your account details</small>
                            </span>
                        </button>
                        
                        <button class="action-btn action-warning" onclick="loadWalletQuick()">
                            <span class="action-icon">üí∞</span>
                            <span class="action-text">
                                <strong>Wallet & Gold</strong>
                                <small>Check your currencies</small>
                            </span>
                        </button>
                    </div>
                </div>
                
                <!-- Guild Tracking Overview -->
                <div class="team-overview">
                    <h3>ÔøΩ Tracked Guilds by Team</h3>
                    <div class="team-bars">
                        <div class="team-bar-item">
                            <div class="team-bar-label" onclick="toggleTeamGuilds('red')" style="cursor: pointer;" title="Click to view guilds">
                                <span>
                                    <span id="red-team-label" style="color: #ff6b6b">üî¥ Red Team</span>
                                    <span id="red-dropdown-arrow" style="display: inline-block; transition: transform 0.2s; margin-left: 5px;">‚ñº</span>
                                </span>
                                <span id="red-guild-count">0 guilds</span>
                            </div>
                            <div class="team-bar-bg">
                                <div class="team-bar-fill team-red" id="red-bar" style="width: 0%"></div>
                            </div>
                            <div id="red-guilds-dropdown" class="team-guilds-dropdown" style="display: none;"></div>
                        </div>
                        
                        <div class="team-bar-item">
                            <div class="team-bar-label" onclick="toggleTeamGuilds('green')" style="cursor: pointer;" title="Click to view guilds">
                                <span>
                                    <span id="green-team-label" style="color: #6bff6b">üü¢ Green Team</span>
                                    <span id="green-dropdown-arrow" style="display: inline-block; transition: transform 0.2s; margin-left: 5px;">‚ñº</span>
                                </span>
                                <span id="green-guild-count">0 guilds</span>
                            </div>
                            <div class="team-bar-bg">
                                <div class="team-bar-fill team-green" id="green-bar" style="width: 0%"></div>
                            </div>
                            <div id="green-guilds-dropdown" class="team-guilds-dropdown" style="display: none;"></div>
                        </div>
                        
                        <div class="team-bar-item">
                            <div class="team-bar-label" onclick="toggleTeamGuilds('blue')" style="cursor: pointer;" title="Click to view guilds">
                                <span>
                                    <span id="blue-team-label" style="color: #6b6bff">üîµ Blue Team</span>
                                    <span id="blue-dropdown-arrow" style="display: inline-block; transition: transform 0.2s; margin-left: 5px;">‚ñº</span>
                                </span>
                                <span id="blue-guild-count">0 guilds</span>
                            </div>
                            <div class="team-bar-bg">
                                <div class="team-bar-fill team-blue" id="blue-bar" style="width: 0%"></div>
                            </div>
                            <div id="blue-guilds-dropdown" class="team-guilds-dropdown" style="display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- WvW Activity Timeline -->
                <div class="activity-timeline-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">‚öîÔ∏è Objective Capture Activity</h3>
                        <div class="time-window-selector">
                            <button onclick="setActivityTimeWindow('6h')" id="activity-window-6h" class="time-window-btn active">6 Hours</button>
                            <button onclick="setActivityTimeWindow('24h')" id="activity-window-24h" class="time-window-btn">24 Hours</button>
                            <button onclick="setActivityTimeWindow('7d')" id="activity-window-7d" class="time-window-btn">7 Days</button>
                        </div>
                    </div>
                    <div id="activity-chart-container" class="activity-chart-container" style="position: relative;">
                        <canvas id="activity-chart"></canvas>
                    </div>
                    <div id="activity-legend" class="activity-legend">
                        <span class="legend-item"><span class="legend-dot" style="background: #ff6b6b;"></span> <span id="legend-red-team">Red Team</span></span>
                        <span class="legend-item"><span class="legend-dot" style="background: #6bff6b;"></span> <span id="legend-green-team">Green Team</span></span>
                        <span class="legend-item"><span class="legend-dot" style="background: #6b6bff;"></span> <span id="legend-blue-team">Blue Team</span></span>
                    </div>
                </div>
                
                <!-- K/D Ratio Timeline -->
                <div class="activity-timeline-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">üíÄ Kill/Death Ratio Trends</h3>
                        <div class="time-window-selector">
                            <button onclick="setKDRTimeWindow('6h')" id="kdr-window-6h" class="time-window-btn active">6 Hours</button>
                            <button onclick="setKDRTimeWindow('24h')" id="kdr-window-24h" class="time-window-btn">24 Hours</button>
                            <button onclick="setKDRTimeWindow('7d')" id="kdr-window-7d" class="time-window-btn">7 Days</button>
                        </div>
                    </div>
                    <div id="kdr-chart-container" class="activity-chart-container" style="position: relative;">
                        <canvas id="kdr-chart"></canvas>
                    </div>
                    <div id="kdr-legend" class="activity-legend">
                        <span class="legend-item"><span class="legend-dot" style="background: #ff6b6b;"></span> <span id="kdr-legend-red-team">Red Team</span></span>
                        <span class="legend-item"><span class="legend-dot" style="background: #6bff6b;"></span> <span id="kdr-legend-green-team">Green Team</span></span>
                        <span class="legend-item"><span class="legend-dot" style="background: #6b6bff;"></span> <span id="kdr-legend-blue-team">Blue Team</span></span>
                    </div>
                </div>

                <!-- PPT Coverage Analysis -->
                <div class="activity-timeline-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h3 style="margin: 0;">üìà PPT Coverage Analysis</h3>
                        <div class="time-window-selector">
                            <button onclick="setPPTTimeWindow('6h')" id="ppt-window-6h" class="time-window-btn active">6 Hours</button>
                            <button onclick="setPPTTimeWindow('24h')" id="ppt-window-24h" class="time-window-btn">24 Hours</button>
                            <button onclick="setPPTTimeWindow('7d')" id="ppt-window-7d" class="time-window-btn">7 Days</button>
                        </div>
                    </div>
                    <div id="ppt-chart-container" class="activity-chart-container" style="position: relative;">
                        <canvas id="ppt-chart"></canvas>
                    </div>
                    <div id="ppt-legend" class="activity-legend">
                        <span class="legend-item"><span class="legend-dot" style="background: #ff6b6b;"></span> <span id="ppt-legend-red-team">Red Team</span></span>
                        <span class="legend-item"><span class="legend-dot" style="background: #6bff6b;"></span> <span id="ppt-legend-green-team">Green Team</span></span>
                        <span class="legend-item"><span class="legend-dot" style="background: #6b6bff;"></span> <span id="ppt-legend-blue-team">Blue Team</span></span>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 6px; font-size: 0.9em; color: #a0a0a0;">
                        <strong style="color: #d4af37;">üí° Coverage Gap Indicator:</strong> Dips in PPT indicate periods when your team lost objectives. Consistent low PPT suggests coverage gaps during off-peak hours.
                    </div>
                </div>

                <div id="dashboard-result" class="result-container"></div>
            </div>

            <!-- Account Tab -->
            <div id="account" class="tab-content">
                <h2>Account Information</h2>
                <div class="button-group">
                    <button onclick="loadAccountDetails()" class="btn btn-primary">Load Account</button>
                    <button onclick="loadWallet()" class="btn btn-primary">Load Wallet</button>
                </div>
                <div id="account-result" class="result-container"></div>
            </div>

            <!-- Characters Tab -->
            <div id="characters" class="tab-content">
                <h2>Characters</h2>
                <div class="button-group">
                    <button onclick="loadCharacterList()" class="btn btn-primary">Load Characters</button>
                </div>
                <div id="character-select"></div>
                <div id="characters-result" class="result-container"></div>
            </div>

            <!-- WvW Tab -->
            <div id="wvw" class="tab-content">
                <h2>World vs World (WvW)</h2>
                
                <!-- Interactive Maps Section -->
                <div class="wvw-maps-section">
                    <div class="map-controls">
                        <div id="map-selector" class="map-selector"></div>
                        <button onclick="initWvWMaps()" class="btn btn-primary">
                            üîÑ Load Interactive Maps
                        </button>
                        <label style="margin-left: 10px; display: inline-flex; align-items: center; gap: 6px;">
                            <input id="toggle-grid" type="checkbox" checked onchange="renderMap(window.currentMapType)"/>
                            Show grid
                        </label>
                        <button onclick="stopAutoRefresh()" class="btn btn-small">‚è∏Ô∏è Pause</button>
                        <button onclick="startAutoRefresh()" class="btn btn-small">‚ñ∂Ô∏è Resume</button>
                    </div>
                    
                    <div class="map-container">
                        <div id="map-canvas" class="map-canvas">
                            <p style="text-align: center; padding: 50px; opacity: 0.6;">
                                Click "Load Interactive Maps" to view live WvW battlefield status
                            </p>
                        </div>
                        <div id="objective-details" class="objective-details-panel">
                            <p style="opacity: 0.6; text-align: center; padding: 20px;">
                                Click an objective on the map to view details
                            </p>
                        </div>
                    </div>
                </div>
                
                <hr style="margin: 30px 0; border-color: #444;">
                
                <h3>Match Data & Guild Tracking</h3>
                <div class="wvw-controls">
                    <div class="button-group">
                        <button onclick="loadAllWvWMatches()" class="btn btn-primary">Load All Matches</button>
                        <button onclick="loadMyWorldMatch()" class="btn btn-primary">My World's Match</button>
                        <button onclick="loadTrackedGuilds()" class="btn btn-secondary">üìä View Tracked Guilds</button>
                    </div>
                    
                    <div class="query-form" style="margin-top: 20px;">
                        <label>Check Specific World:</label>
                        <div class="input-group">
                            <input type="number" id="wvw-world-id" placeholder="Enter World ID (e.g., 1020)" class="input-text">
                            <button onclick="loadSpecificWorldMatch()" class="btn btn-secondary">Get Match</button>
                        </div>
                        <div class="preset-items">
                            <p>Quick select:</p>
                            <button onclick="setWorldId(1001)" class="btn btn-small">Anvil Rock</button>
                            <button onclick="setWorldId(1002)" class="btn btn-small">Borlis Pass</button>
                            <button onclick="setWorldId(1003)" class="btn btn-small">Yak's Bend</button>
                            <button onclick="setWorldId(1004)" class="btn btn-small">Henge of Denravi</button>
                            <button onclick="setWorldId(1005)" class="btn btn-small">Maguuma</button>
                            <button onclick="setWorldId(1006)" class="btn btn-small">Sorrow's Furnace</button>
                        </div>
                    </div>
                </div>
                
                <div id="wvw-result" class="result-container"></div>
            </div>

            <!-- Trading Post Tab -->
            <div id="trading" class="tab-content">
                <h2>Trading Post</h2>

                <!-- Transaction Tabs -->
                <div class="tp-tabs" style="margin-bottom: 20px;">
                    <button class="tp-tab active" onclick="switchTPView('prices')">üîç Price Lookup</button>
                    <button class="tp-tab" onclick="switchTPView('selling')">üì§ Selling</button>
                    <button class="tp-tab" onclick="switchTPView('sold')">‚úÖ Sold</button>
                    <button class="tp-tab" onclick="switchTPView('buying')">üì• Buying</button>
                    <button class="tp-tab" onclick="switchTPView('bought')">‚úÖ Bought</button>
                </div>

                <!-- Price Lookup View -->
                <div id="tp-view-prices" class="tp-view active">
                    <div class="query-form">
                        <label>Search by Item Name:</label>
                        <div class="input-group">
                            <input type="text" id="item-search" placeholder="Type item name (e.g., 'ecto', 'mystic coin')" class="input-text" oninput="searchItems(this.value)">
                        </div>
                        <div id="item-search-results" class="search-results"></div>

                        <label style="margin-top: 20px;">Or Item IDs (comma-separated):</label>
                        <div class="input-group">
                            <input type="text" id="item-ids" placeholder="e.g., 19721, 24277, 19976" class="input-text">
                            <button onclick="loadTradingPost()" class="btn btn-primary">Get Prices</button>
                        </div>
                        <div class="preset-items">
                            <p>Common items:</p>
                            <button onclick="setItemIds('19721')" class="btn btn-small">Glob of Ectoplasm</button>
                            <button onclick="setItemIds('24277')" class="btn btn-small">Mystic Coin</button>
                            <button onclick="setItemIds('19976')" class="btn btn-small">T6 Blood</button>
                            <button onclick="setItemIds('19721,24277,19976')" class="btn btn-small">All Three</button>
                        </div>
                    </div>
                </div>

                <!-- Selling View -->
                <div id="tp-view-selling" class="tp-view">
                    <button onclick="loadTPTransactions('current-sells')" class="btn btn-primary">Load Current Sell Listings</button>
                </div>

                <!-- Sold View -->
                <div id="tp-view-sold" class="tp-view">
                    <button onclick="loadTPTransactions('history-sells')" class="btn btn-primary">Load Sell History (90 days)</button>
                </div>

                <!-- Buying View -->
                <div id="tp-view-buying" class="tp-view">
                    <button onclick="loadTPTransactions('current-buys')" class="btn btn-primary">Load Current Buy Orders</button>
                </div>

                <!-- Bought View -->
                <div id="tp-view-bought" class="tp-view">
                    <button onclick="loadTPTransactions('history-buys')" class="btn btn-primary">Load Buy History (90 days)</button>
                </div>

                <div id="trading-result" class="result-container"></div>
            </div>

            <!-- Custom Query Tab -->
            <div id="query" class="tab-content">
                <h2>Custom API Query</h2>
                <div class="query-form">
                    <label>Endpoint:</label>
                    <input type="text" id="custom-endpoint" placeholder="e.g., achievements/daily" class="input-text">
                    
                    <label>Parameters (JSON, optional):</label>
                    <textarea id="custom-params" placeholder='{"ids": "all"}' class="input-textarea"></textarea>
                    
                    <button onclick="executeCustomQuery()" class="btn btn-primary">Execute Query</button>
                    
                    <div class="preset-queries">
                        <p>Quick queries:</p>
                        <button onclick="setQuery('build', '{}')" class="btn btn-small">Game Build</button>
                        <button onclick="setQuery('achievements/daily', '{}')" class="btn btn-small">Daily Achievements</button>
                        <button onclick="setQuery('dailycrafting', '{}')" class="btn btn-small">Daily Crafting</button>
                        <button onclick="setQuery('worlds', '{\"ids\": \"all\"}')" class="btn btn-small">All Worlds</button>
                    </div>
                </div>
                <div id="query-result" class="result-container"></div>
            </div>

            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <h2>Settings</h2>
                
                <div class="settings-section">
                    <h3>API Key Configuration</h3>
                    <div id="current-key-status"></div>
                    
                    <div class="query-form">
                        <label>API Key:</label>
                        <input type="password" id="new-api-key" placeholder="Enter your GW2 API key" class="input-text">
                        <div class="button-group">
                            <button onclick="saveApiKey()" class="btn btn-primary">Save API Key</button>
                            <button onclick="toggleKeyVisibility()" class="btn btn-secondary">Show/Hide</button>
                            <button onclick="deleteApiKey()" class="btn btn-danger">Delete API Key</button>
                        </div>
                        
                        <div class="info-box">
                            <p><strong>Get your API key:</strong></p>
                            <ol>
                                <li>Visit <a href="https://account.arena.net/applications" target="_blank">https://account.arena.net/applications</a></li>
                                <li>Create a new key or use an existing one</li>
                                <li>Enable the permissions you want (account, wallet, characters, etc.)</li>
                                <li>Paste the key above and click Save</li>
                            </ol>
                            <p><strong>Note:</strong> To see guild information in WvW, your API key needs the "guilds" permission.</p>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3>About</h3>
                    <p>Guild Wars 2 API Tool - Web Interface</p>
                    <p>Version 1.0</p>
                    <p>A simple interface to interact with the GW2 API without coding.</p>
                </div>
            </div>
        </main>
    </div>

    <script src="/static/app.js"></script>
    <script src="/static/wvw-maps.js"></script>
</body>
</html>
